---
layout:     post
title:      "N1盒子折腾"
subtitle:   ""
date:       2024-08-05
author:     "hcy"
header-img: "img/gene-head-img.jpg"
tags:
- 斐讯N1
- linux
- debian
- armbian
typora-root-url: ..
---

# 前言

## 安装系统


## 安装docker


## 磁盘挂载
机器只有8g内存，安装完系统可用6g左右，需要挂载一个外置磁盘。
首先使用 `lsblk`命令查看磁盘挂载情况，外接磁盘一般是 sda，我这边只有一个分区，因此 sda1就是我的磁盘，后面的/mnt/sharefile是我的挂载点，刚开始时是没有的。
```
root@armbian:~# lsblk
NAME         MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda            8:0    0 298.1G  0 disk 
└─sda1         8:1    0 298.1G  0 part /mnt/sharefile
mmcblk2      179:0    0   7.3G  0 disk 
├─mmcblk2p1  179:1    0   511M  0 part /boot
└─mmcblk2p2  179:2    0   6.5G  0 part /
mmcblk2boot0 179:32   0     4M  1 disk 
mmcblk2boot1 179:64   0     4M  1 disk 
zram0        254:0    0    50M  0 disk /var/log
```

#### 临时挂载
事先将磁盘格式化成ext4格式，在window上操作好比命令行方便点  
然后创建挂在点，在想要挂载的地方创建一个文件夹，我这里是 `mkdir /mnt/sharefile`  
开始挂载，使用命令 `mount -v /dev/sda1 /mnt/sharefile` 将sda1挂载到sharefile下，逻辑是一样的，具体是sda还是什么名字，可以通过磁盘大小猜出来的。  
挂载完成后可以再次通过`lsblk`查看，同事访问/mnt/sharefile就可以进入我们的磁盘了

但是这种挂载方式是临时挂载，重启就要重新做，通过修改fstab可以做到系统启动自动挂载，下面是方法。


#### 启动自动挂载
首先通过blkid命令查询硬盘uuid，因为前面的名字 sda是系统生成的，再插入一块硬盘第二块就是sdb、sdc等等，不是固定的。如果你的两个usd插口都插了硬盘下次哪个在前哪个在后就不能确定了。
但是uuid是与硬盘绑定的，只要你不对硬盘进行分区，不进行格式化，他的uud相对是固定的。
```shell
root@armbian:~# blkid
/dev/mmcblk2p2: LABEL="ROOTFS_EMMC" UUID="305f8c97-3156-491a-93b6-56ba0ca87ee3" BLOCK_SIZE="4096" TYPE="ext4"
/dev/mmcblk2p1: LABEL_FATBOOT="BOOT_EMMC" LABEL="BOOT_EMMC" UUID="5933-954E" BLOCK_SIZE="512" TYPE="vfat"
/dev/sda1: UUID="09ef634f-5af8-f24e-9497-b668e4fbc413" BLOCK_SIZE="4096" TYPE="ext4" PARTLABEL="Linux data partition" PARTUUID="825c0d80-6904-43c2-abe0-ac0e0060d9f0"
/dev/zram0: LABEL="log2ram" UUID="e96a98e0-5366-4843-9dd8-2a8aee06f61f" BLOCK_SIZE="4096" TYPE="ext4"
```
可以看到我的硬盘的UUID="09ef634f-5af8-f24e-9497-b668e4fbc413"，格式是ext4  
备份然后编辑 /etc/fstab 文件，在原先的后面增加一行配置，一共6段数据，中间使用空格分割（几个空格没关系）  
第一段填写UUID，不需要引号引用  
第二段填写挂在点，提前创建好文件夹  
第三段填写磁盘格式，这里是ext4  
第四段填写 `defaults,nofail`，nofail 可以防止磁盘不可用时系统启动不起来  
第五段六段填写 0  

```shell
UUID=09ef634f-5af8-f24e-9497-b668e4fbc413    /mnt/sharefile    ext4    defaults,nofail    0    0
```

配置完成后先将上面测试用的挂载去掉

    umount /mnt/sharefile
然后执行：

    mount -a
如果没有报错，并且 lsblk 命令再次查看能够挂载成功则说明我们配置的 fstab是没错的。如果报错了或者没有成功则说明fstab配置的有问题，请将备份配置文件还原回去，再检查下是不是配错了，不然可能导致重启后启动不起来。  
成功后，重启机器磁盘就可以自动挂载上去了。




## 配置系统

### 1.配置apt
  编辑 '/etc/apt/sources.list'文件，修改为清华apt源,将下面内容替换进去即可，一共四行

**bullseye 版本使用这个**
```
deb http://mirrors.tuna.tsinghua.edu.cn/debian bullseye main contrib non-free
deb http://mirrors.tuna.tsinghua.edu.cn/debian bullseye-updates main contrib non-free
deb http://mirrors.tuna.tsinghua.edu.cn/debian bullseye-backports main contrib non-free
deb http://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free
```

**bookworm 使用这个**
```
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm main contrib non-free non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-updates main contrib non-free non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-backports main contrib non-free non-free-firmware
deb https://security.debian.org/debian-security bookworm-security main contrib non-free non-free-firmware
```

### 2.更新软件
通过命令刷新软件列表和更新软件  
apt update   -- 刷新列表  
apt upgrade  -- 更新软件  

### 3.命令提示建议

  command 'lala' not found, did you mea 功能  
  当输入命令出现错别字时，会提示`command not found`, 通过安装 `apt install command-not-found`工具（需重新连接shell）后给出建议，效果如下。

```
root@debian:/root# lala
Command 'lala' not found, did you mean:
  command 'nala' from deb nala
  command 'vala' from deb valac-bin
  command 'lola' from deb lola
Try: apt install <deb name>
```

### 4. 配置ssh端口
  使用默认的ssh 22端口不太安全，更换成其他端口更不容易被扫描。

```
cd /etc/ssh
vi sshd_config
```
1. 将原先被注释掉的 Port 22 恢复，并再增加一条 Port 5000。Port可以配置多个。
2. 使用命令 systemctl restart sshd重启 ssh服务
3. 再开一个端口连接5000 如果能正常连接进去说明配置生效，按照上面的方法将22端口注释掉


### 5.开启ssh认证日志
  ssh连接的日志会输出到 '/opt/log/auth.log'文件下的，后面要安装的fail2ban也是依赖该文件判定登陆是否成功，失败多少次的，如果你没有这个文件可能是缺少了系统日志服务。  

使用命令 `ps -ef |grep rsyslogd` 查看 rsyslogd是否存在  
如果不存在 使用 `apt install rsyslogd` 安装  
启动服务 `systemctl start rsyslog`  
这样就可以输出登陆认证日志了

### 6. 安装fail2ban
  fail2ban可以有效的方式暴力破解的方式，他会监听ssh的登陆日志，如果密码错误超过一定次数直接封禁ip。  
建议安装在宿主机上而不是docker里，过程如下。

1. 安装 `apt install fail2ban`
2. 启动 `systemctl start fail2ban`  

    默认情况下fail2ban开启了ssh服务的拦截，不过是在22端口，因为上面我们修改了端口好，即使fail2ban能够通过日志发现黑客的攻击，但是只会通过iptables封掉对应的22端口
   的访问，因为我们修改了ssh的端口号还可以继续攻击。
3. 配置修改配置文件 `/etc/fail2ban/jail.d/defaults-debian.conf`
这里我配置了端口号，并配置了封禁时间96小时，失败5次即封ip
    ```ini
    [sshd]
    enabled = true
    port = 30000
    bantime  = 96h
    maxretry = 5
    ```
4. 重启fail2ban `systemctl restart fail2ban`

5. 查看fail2ban
    fail2ban提供了服务端和客户端，一般我们操作客户端命令查看fail2ban的运行情况。常用的命令如下

    ```
    fail2ban-client status  查看整体状态
    fail2ban-client status sshd  查看ssh的状态
    fail2ban-client get sshd banip --with-time 查看ssh被封的ip，把封禁时间和解封时间都展示出来
    
    fail2ban-client set sshd banip 555.222.111.222  手动封禁一个ip
    fail2ban-client set sshd unbanip 555.222.111.222  手动解封一个ip
    ```

更详细可的可以查看 fail2ban-client --help

6. 查看fail2ban的日志
日志在 `/var/log/fail2ban.log`下，里面有详细的封禁、解封日志

   
### 配置语言环境 locale





## docker配置


## 一些命令
vnstat 
    展示过去流量汇总情况，可通过添加 -l参数查看实时流量

sysstat是一个工具包,包含有几个很有用的系统检测程序,iostat,mpstat和sar.
iostat用于磁盘I/O分区的统计信息.可以用来分析磁盘I/O,带宽等信息.
    iostat -m 2，没2秒输出一次信息，以MB为单位展示（默认KB）
mpstat用于输出CPU的各种统计信息. 可以用来分析程序运行时在内核态和用户态的工作情况.
sar用于定时搜集系统的各种状态信息.然后可以对系统各个时间点的状态进行监控.








