---

layout:     post
title:      "h2数据库初探"
subtitle:   ""
date:       2020-02-26
author:     "hcy"
header-img: "img/gene-head-img.jpg"
tags:
- h2
- 数据库
typora-root-url: ..
---



首先是这个h2数据库的官网[http://www.h2database.com](http://www.h2database.com)

当前最新的maven：

```xml
        <dependency>
            <groupId>com.h2database</groupId>
            <artifactId>h2</artifactId>
            <version>1.4.200</version>
        </dependency>
```



## 1.两种运行模式

h2数据库可以运行在嵌入模式下可以将它想象成一个`HashMap`这样的，也可以运行在独立模式下，这样的话可以想象成是`Redis`这样的程序。

独立模式类比于`Redis`这样的程序，多个应用程序能共用这一个数据库。

嵌入模式可以随程序一起启动，程序停止数据库也停止。

半嵌入模式，即程序A嵌入启动数据库，程序B可以通过A操作数据库，数据库扔随着A关闭而关闭。

我们主要讲一讲内嵌模式。



## 2. 先启动起来再说

首先引入maven

```xml
        <dependency>
            <groupId>com.h2database</groupId>
            <artifactId>h2</artifactId>
            <version>1.4.200</version>
            <scope>test</scope>
        </dependency>
```

然后在测试类里面写一个main方法

```java
    public static void main(String[] args) throws SQLException, ClassNotFoundException {
        Class.forName("org.h2.Driver");
        Connection conn = DriverManager.getConnection("jdbc:h2:~/test", "sa", "");
    }
```

上面最简单就能获取到了通往数据库的连接，看看我们做了什么？

第一行代码，将`h2`的启动注册到`DriverManager`,这个驱动文件已经集合在了`h2` 的`jar`包里了。

第二行代码，获取连接，从`url`能看出我们想要获取一个名为`test`，用户名为`sa`，密码为空的数据库连接，因为第一次访问是不存在的，所以程序会在 `~/`目录下创建一个`test.db`文件，且设置用户名密码为我们填写的。



`~/`目录在`window`系统上就是用户目录我的电脑上`C:\Users\xiaoming\test.db`已经生成了，大家可以找找。



以后我们在此使用此`url`和用户名密码就能获取到`test`这个库的连接了，如果后面填写的用户名或密码和第一次生成时设置的不一样是不能获取到连接的。



## 3. 使用网页管理

上面简单两行代码就成功创建了一个数据库，且获取了连接，但数据库是空的，且没办法直观的看到数据，这是可以使用它内置的网页管理工具，我们在网页上就能连上。

```java
    public static void main(String[] args) throws SQLException, ClassNotFoundException {

        Class.forName("org.h2.Driver");
        Connection conn = DriverManager.getConnection("jdbc:h2:~/test", "sa", "");
		//创建一个网页管理服务，并启动
        Server.createWebServer().start();
    }
```



我们开启了一个网页管理服务，因为上面执行获取`Connection`时已经创建的`test.db`,所以第1，2行代码不执行也可以的。有了网页服务，我们打开浏览器输入`http://localhost:8082`,进入



![image-20200226215023374](/img/in/2020-02-26-h2%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E6%8E%A2/image-20200226215023374.png)

网页内容如上，我们正确填写了` jdbc url`，`用户名`，`密码`，这些就是创建数据库时一致的，就能进入管理后台



![image-20200226215137165](/img/in/2020-02-26-h2%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E6%8E%A2/image-20200226215137165.png)



这也很好理解，第一次我们使用`DriverManager`获取连接时，`h2`为我们在指定位置生成了一个`test.db`文件，这个文件就是我们的数据库，且使用给定的用户名密码加密了。第二次我们启动了一个`WebServer`，通过网页我们可以告诉`WebServer`去哪里查找数据库，使用的用户名密码是什么，这样我们第二次启动的程序就能再把`test.db`加载到内存里，读写它。



## 4. 使用数据库管理工具管理

回想一下，首先我们使用`DriverManager`获取连接，此时`h2`帮我们创建了数据库，但是操作起来很麻烦，且不能直观查看数据。

然后我们发现可以启动一个网页管理Server，用这个来操作数据库，很直观。





如果我们想要程序A开启一个嵌入数据库，程序B通过`jdbc`连接上来读取数据，那该怎么办呢？

我们可以在程序A中开启一个TcpServer，提供一个服务出去供其他程序访问，比如我们在A程序中

```java
    public static void main(String[] args) throws SQLException {
        Server.createTcpServer().start();
    }
```



程序B里面这样写

```java
{
Class.forName("org.h2.Driver");
Connection conn = DriverManager.getConnection("jdbc:h2:tcp:localhost:9092/~/test", "sa", "");
}
```

注意`url`变了，这样我们就能在程序B里面获取A开启的9092端口的监听，程序B里面做的数据库操作或通过Tcp传送到A上，最终反映到数据库上，A就成了一个B的代理。





## 5.总结

本文讲了h2数据库的嵌入模式下的基本使用，

第一次获取连接时将使用我们输入的用户名密码和连接创建一个数据库，我们可以在程序中获取此数据库的连接。

但是不方便操作，所以我们启动一个`Server.createWebServer().start()`监听8082端口，来在网页上管理数据库。

如果想让其他程序也能操作数据库，可以开启`Server.createTcpServer().start()`,让其他程序通过本程序做跳板操作数据库。



本程序操作时连接是 `jdbc:h2:~/test`

通过tcp访问时连接是`jdbc:h2:tcp:localhost:9092/~/test`

其中前面部分`jdbc:h2:`是固定的，后面是db数据库存储的位置，比如`jdbc:h2:d:abc/test`这样就会把数据库创建在`d:/abc/test.db`。 或者使用`jdbc:h2:./test` 这样的相对路径，可以把数据库创建在程序执行的目录下。



h2还为我们提供了简单的连接池，使用方式如:

```java
JdbcConnectionPool cp = JdbcConnectionPool.create("jdbc:h2:~/test", "", "");
Connection conn = cp.getConnection();
conn.close();
cp.dispose();
```

